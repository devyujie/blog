//- Analytics tracking
if theme.google_analytics
    script.
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', '#{theme.google_analytics}']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();

script.
    var __scrollHandlers = []
    var __scrollListenerBound = false
    var __scrollTicking = false
    var __scrollToTopFrame = null
    var __live2dOptions = !{JSON.stringify(theme.live2d || {})}
    var __postTocCleanup = null
    var __pjaxBound = false
    var __pjaxLoading = false
    var __pjaxAbortController = null
    var __pjaxCurrentPath = null
    var __pjaxCache = new Map()
    var __pjaxCacheLimit = 24
    var __pjaxLoadingTimer = null
    var __pjaxPrefetchBound = false
    var __pjaxPrefetchInFlight = {}

    function registerScrollHandler(handler) {
        if (typeof handler !== 'function') return function() {}
        __scrollHandlers.push(handler)
        if (!__scrollListenerBound) {
            window.addEventListener('scroll', function() {
                if (__scrollTicking) return
                __scrollTicking = true
                window.requestAnimationFrame(function() {
                    __scrollTicking = false
                    for (var i = 0; i < __scrollHandlers.length; i += 1) {
                        try {
                            __scrollHandlers[i]()
                        } catch (err) {
                        }
                    }
                })
            }, { passive: true })
            __scrollListenerBound = true
        }

        return function unregisterScrollHandler() {
            var index = __scrollHandlers.indexOf(handler)
            if (index === -1) return
            __scrollHandlers.splice(index, 1)
        }
    }

    function normalizePathname(pathname) {
        if (!pathname) return '/'
        var normalized = pathname
        normalized = normalized.replace(/\/index\.html$/, '/')
        if (normalized.length > 1 && normalized.charAt(normalized.length - 1) === '/') {
            normalized = normalized.slice(0, -1)
        }
        return normalized || '/'
    }

    function extractPathname(href) {
        try {
            return new URL(href, window.location.origin).pathname || '/'
        } catch (err) {
            return href || '/'
        }
    }

    function createPjaxUrl(href) {
        var nextUrl = null
        try {
            nextUrl = new URL(href, window.location.href)
        } catch (err) {
            return null
        }
        if (!nextUrl) return null
        if (nextUrl.origin !== window.location.origin) return null
        if (nextUrl.protocol !== 'http:' && nextUrl.protocol !== 'https:') return null
        return nextUrl
    }

    function getRouteKeyFromUrl(url) {
        if (!url) return '/'
        return normalizePathname(url.pathname || '/') + (url.search || '')
    }

    function getPjaxCacheKey(url) {
        if (!url) return ''
        return url.origin + getRouteKeyFromUrl(url)
    }

    function setPjaxCache(key, html) {
        if (!key || !html) return
        if (__pjaxCache.has(key)) {
            __pjaxCache.delete(key)
        }
        __pjaxCache.set(key, html)
        if (__pjaxCache.size <= __pjaxCacheLimit) return
        var firstKey = __pjaxCache.keys().next().value
        if (firstKey) {
            __pjaxCache.delete(firstKey)
        }
    }

    function getCachedPjaxHtml(url) {
        var key = getPjaxCacheKey(url)
        if (!key || !__pjaxCache.has(key)) return null
        var html = __pjaxCache.get(key)
        // LRU bump
        __pjaxCache.delete(key)
        __pjaxCache.set(key, html)
        return html
    }

    function fetchPjaxHtml(url, requestOptions) {
        var cached = getCachedPjaxHtml(url)
        if (cached) {
            return Promise.resolve(cached)
        }

        return fetch(url.href, requestOptions).then(function(response) {
            if (!response.ok) {
                throw new Error('PJAX request failed: ' + response.status)
            }
            return response.text()
        }).then(function(html) {
            setPjaxCache(getPjaxCacheKey(url), html)
            return html
        })
    }

    function isPjaxEligibleLink(link) {
        if (!link) return false
        if (link.hasAttribute('download')) return false

        var target = link.getAttribute('target')
        if (target && target !== '_self') return false
        if (link.hasAttribute('data-no-pjax')) return false

        var href = link.getAttribute('href')
        if (!href) return false
        if (href.indexOf('mailto:') === 0 || href.indexOf('tel:') === 0 || href.indexOf('javascript:') === 0) return false

        var nextUrl = createPjaxUrl(href)
        if (!nextUrl) return false

        var currentRouteKey = getRouteKeyFromUrl(new URL(window.location.href))
        var nextRouteKey = getRouteKeyFromUrl(nextUrl)
        if (currentRouteKey === nextRouteKey && nextUrl.hash) {
            return false
        }
        return true
    }

    function prefetchPjaxUrl(href) {
        var url = createPjaxUrl(href)
        if (!url) return
        var key = getPjaxCacheKey(url)
        if (!key || __pjaxCache.has(key) || __pjaxPrefetchInFlight[key]) return

        __pjaxPrefetchInFlight[key] = true
        fetch(url.href, { credentials: 'same-origin' }).then(function(response) {
            if (!response.ok) return null
            return response.text()
        }).then(function(html) {
            if (!html) return
            setPjaxCache(key, html)
        }).catch(function() {
        }).finally(function() {
            delete __pjaxPrefetchInFlight[key]
        })
    }

    function updateNavActiveState() {
        var current = normalizePathname(window.location.pathname || '/')
        var links = document.querySelectorAll('.site-header .nav-list-link')
        if (!links || !links.length) return

        Array.prototype.forEach.call(links, function(link) {
            var href = link.getAttribute('href') || '/'
            var path = normalizePathname(extractPathname(href))
            var isActive = false

            if (path === '/') {
                isActive = current === '/'
            } else if (path.indexOf('/archives') === 0) {
                isActive = current.indexOf('/archives') === 0
            } else {
                isActive = current.indexOf(path) === 0
            }

            link.classList.toggle('is-active', isActive)
        })
    }

    function syncMetaContent(nextDoc, selector, removeIfMissing) {
        var nextMeta = nextDoc.head.querySelector(selector)
        var currentMeta = document.head.querySelector(selector)

        if (!nextMeta) {
            if (removeIfMissing && currentMeta && currentMeta.parentNode) {
                currentMeta.parentNode.removeChild(currentMeta)
            }
            return
        }

        if (!currentMeta) {
            document.head.appendChild(nextMeta.cloneNode(true))
            return
        }

        var content = nextMeta.getAttribute('content')
        if (content !== null) {
            currentMeta.setAttribute('content', content)
        }
    }

    function syncDocumentHead(nextDoc) {
        if (!nextDoc || !nextDoc.head) return
        if (nextDoc.title) {
            document.title = nextDoc.title
        }

        syncMetaContent(nextDoc, 'meta[name="description"]', false)
        syncMetaContent(nextDoc, 'meta[property="og:title"]', false)
        syncMetaContent(nextDoc, 'meta[property="og:description"]', false)
        syncMetaContent(nextDoc, 'meta[property="og:url"]', false)
        syncMetaContent(nextDoc, 'meta[property="article:published_time"]', true)
        syncMetaContent(nextDoc, 'meta[property="article:modified_time"]', true)
    }

    function shouldHandlePjaxLink(link, event) {
        if (!link) return false
        if (event.defaultPrevented) return false
        if (event.button !== 0) return false
        if (event.metaKey || event.ctrlKey || event.shiftKey || event.altKey) return false
        if (!isPjaxEligibleLink(link)) return false

        var href = link.getAttribute('href')
        var nextUrl = createPjaxUrl(href)
        if (!nextUrl) return false

        var currentPath = normalizePathname(window.location.pathname || '/')
        var nextPath = normalizePathname(nextUrl.pathname || '/')
        if (currentPath === nextPath && nextUrl.hash) {
            return false
        }

        return true
    }

    function scrollToHash(hash) {
        if (!hash) return false
        var raw = hash.charAt(0) === '#' ? hash.slice(1) : hash
        if (!raw) return false

        var id = raw
        try {
            id = decodeURIComponent(raw)
        } catch (err) {
        }

        var target = document.getElementById(id)
        if (!target) return false

        var header = document.querySelector('.site-header')
        var offset = header ? header.getBoundingClientRect().height : 0
        var top = target.getBoundingClientRect().top + (window.scrollY || document.documentElement.scrollTop || 0) - offset
        window.scrollTo(0, Math.max(0, Math.round(top)))
        return true
    }

    function setPjaxLoading(isLoading) {
        __pjaxLoading = !!isLoading
        var root = document.getElementById('swup')
        if (!root) return
        if (__pjaxLoadingTimer) {
            window.clearTimeout(__pjaxLoadingTimer)
            __pjaxLoadingTimer = null
        }

        if (__pjaxLoading) {
            __pjaxLoadingTimer = window.setTimeout(function() {
                root.classList.add('is-pjax-loading')
            }, 120)
            return
        }

        root.classList.remove('is-pjax-loading')
    }

    function scrollToTop(duration) {
        var start = window.scrollY || document.documentElement.scrollTop || 0
        if (start <= 0) return
        if (__scrollToTopFrame) {
            window.cancelAnimationFrame(__scrollToTopFrame)
            __scrollToTopFrame = null
        }
        window.__isProgrammaticScroll = true
        window.scrollTo(0, 0)
        window.__isProgrammaticScroll = false
    }

    function initBackToTop() {
        var button = document.getElementById('back-to-top')
        if (!button) return

        if (button.__backToTopBound && typeof button.__toggleBackToTop === 'function') {
            button.__toggleBackToTop()
            return
        }

        button.__toggleBackToTop = function() {
            if (window.scrollY > 300) {
                button.classList.add('show')
            } else {
                button.classList.remove('show')
            }
        }

        registerScrollHandler(button.__toggleBackToTop)
        button.addEventListener('click', function() {
            scrollToTop(700)
        })

        button.__backToTopBound = true
        button.__toggleBackToTop()
    }

    function initLogoScrollTop() {
        var logoLink = document.querySelector('.site-header .branding a')
        if (!logoLink || logoLink.__logoTopBound) return

        logoLink.addEventListener('click', function(event) {
            if (event.defaultPrevented) return
            if (event.button !== 0) return
            if (event.metaKey || event.ctrlKey || event.shiftKey || event.altKey) return

            event.preventDefault()
            var href = logoLink.getAttribute('href') || '/'
            var target = href
            try {
                target = new URL(href, window.location.origin).pathname
            } catch (err) {
            }
            var current = window.location.pathname
            if (current === target) {
                window.scrollTo(0, 0)
                return
            }
            if (typeof window.__navigateWithPjax === 'function') {
                window.__navigateWithPjax(href, { push: true })
                return
            }
            window.location.href = href
        })

        logoLink.__logoTopBound = true
    }

    function loadGiscus(container) {
        if (!container) return
        if (container.getAttribute('data-loaded') === '1') return

        var repo = container.getAttribute('data-repo')
        if (!repo) return

        var script = document.createElement('script')
        script.src = 'https://giscus.app/client.js'
        script.async = true
        script.crossOrigin = 'anonymous'

        var attrs = [
            'data-repo',
            'data-repo-id',
            'data-category',
            'data-category-id',
            'data-mapping',
            'data-strict',
            'data-reactions-enabled',
            'data-emit-metadata',
            'data-input-position',
            'data-theme',
            'data-lang',
            'data-loading'
        ]

        for (var i = 0; i < attrs.length; i += 1) {
            var key = attrs[i]
            var value = container.getAttribute(key)
            if (value) {
                script.setAttribute(key, value)
            }
        }

        container.innerHTML = ''
        container.appendChild(script)
        container.setAttribute('data-loaded', '1')
    }

    function initGiscusLazy() {
        var container = document.getElementById('giscus-container')
        if (!container) return

        if (typeof window.IntersectionObserver !== 'function') {
            loadGiscus(container)
            return
        }

        if (container.__giscusObserverBound) return

        var observer = new IntersectionObserver(function(entries) {
            if (!entries || !entries.length) return
            for (var i = 0; i < entries.length; i += 1) {
                if (!entries[i].isIntersecting) continue
                loadGiscus(container)
                observer.disconnect()
                return
            }
        }, { rootMargin: '300px 0px' })

        observer.observe(container)
        container.__giscusObserverBound = true
    }


    function ensureScriptOnce(id, src) {
        return new Promise(function(resolve, reject) {
            var existed = document.getElementById(id)
            if (existed) {
                if (existed.getAttribute('data-loaded') === '1') {
                    resolve()
                    return
                }
                existed.addEventListener('load', function() { resolve() }, { once: true })
                existed.addEventListener('error', reject, { once: true })
                return
            }

            var script = document.createElement('script')
            script.id = id
            script.src = src
            script.defer = true
            script.addEventListener('load', function() {
                script.setAttribute('data-loaded', '1')
                resolve()
            }, { once: true })
            script.addEventListener('error', reject, { once: true })
            document.head.appendChild(script)
        })
    }

    function revealLive2DWidget() {
        var markReady = function(widget) {
            if (!widget) return
            if (widget.getAttribute('data-live2d-ready') === '1') return
            window.requestAnimationFrame(function() {
                widget.classList.add('live2d-ready')
                widget.setAttribute('data-live2d-ready', '1')
            })
        }

        var existed = document.getElementById('live2d-widget')
        if (existed) {
            markReady(existed)
            return
        }

        if (!document.body || typeof window.MutationObserver !== 'function') return

        var observer = new MutationObserver(function() {
            var widget = document.getElementById('live2d-widget')
            if (!widget) return
            markReady(widget)
            observer.disconnect()
        })

        observer.observe(document.body, { childList: true, subtree: true })
        window.setTimeout(function() {
            observer.disconnect()
            markReady(document.getElementById('live2d-widget'))
        }, 6000)
    }

    function initLive2D() {
        if (!__live2dOptions || !__live2dOptions.enable) return
        var scriptSrc = __live2dOptions.script || ''
        var modelPath = __live2dOptions.model || ''
        if (!scriptSrc || !modelPath) return
        var onlyOnce = __live2dOptions.once !== false
        var existingWidget = document.getElementById('live2d-widget')
        if (onlyOnce && window.__live2dInitialized && existingWidget) {
            revealLive2DWidget()
            return
        }

        ensureScriptOnce('live2d-widget-script', scriptSrc).then(function() {
            if (!window.L2Dwidget || typeof window.L2Dwidget.init !== 'function') return

            var widget = document.getElementById('live2d-widget')
            if (widget) {
                window.__live2dInitialized = true
                revealLive2DWidget()
                return
            }

            revealLive2DWidget()

            var width = parseInt(__live2dOptions.width, 10)
            var height = parseInt(__live2dOptions.height, 10)
            var hOffset = parseInt(__live2dOptions.hOffset, 10)
            var vOffset = parseInt(__live2dOptions.vOffset, 10)
            var scale = typeof __live2dOptions.scale === 'number' ? __live2dOptions.scale : parseFloat(__live2dOptions.scale)

            window.L2Dwidget.init({
                model: { jsonPath: modelPath },
                display: {
                    position: __live2dOptions.position || 'right',
                    width: Number.isFinite(width) ? width : 150,
                    height: Number.isFinite(height) ? height : 300,
                    hOffset: Number.isFinite(hOffset) ? hOffset : 0,
                    vOffset: Number.isFinite(vOffset) ? vOffset : -20
                },
                mobile: {
                    show: __live2dOptions.mobile !== false,
                    scale: Number.isFinite(scale) ? scale : 0.8
                },
                react: {
                    opacityDefault: Number.isFinite(__live2dOptions.opacityDefault) ? __live2dOptions.opacityDefault : 0.7,
                    opacityOnHover: Number.isFinite(__live2dOptions.opacityOnHover) ? __live2dOptions.opacityOnHover : 0.2
                }
            })
            window.__live2dInitialized = true

            // The widget element is injected asynchronously by the library.
            window.setTimeout(revealLive2DWidget, 120)
            window.setTimeout(revealLive2DWidget, 420)
        }).catch(function() {
        })
    }

    function initImagePreview() {
        var images = document.querySelectorAll('.post-content img')
        if (!images || !images.length) return

        Array.prototype.forEach.call(images, function(image, index) {
            image.classList.add('previewable-image')
            image.style.cursor = 'zoom-in'
            if (!image.hasAttribute('loading')) {
                image.setAttribute('loading', 'lazy')
            }
            if (!image.hasAttribute('decoding')) {
                image.setAttribute('decoding', 'async')
            }
            if (index === 0 && !image.hasAttribute('fetchpriority')) {
                image.setAttribute('fetchpriority', 'high')
            }
        })

        var applyMediumZoom = function() {
            if (!window.mediumZoom) return

            if (!window.__mediumZoomInstance) {
                window.__mediumZoomInstance = window.mediumZoom('.post-content img.previewable-image', {
                    margin: 24,
                    background: 'rgba(0, 0, 0, 0.9)',
                    scrollOffset: 40
                })

                window.__mediumZoomInstance.on('open', function() {
                    document.body.classList.add('zoom-preview-open')
                })

                window.__mediumZoomInstance.on('closed', function() {
                    document.body.classList.remove('zoom-preview-open')
                })

                return
            }

            if (typeof window.__mediumZoomInstance.detach === 'function') {
                window.__mediumZoomInstance.detach()
            }

            window.__mediumZoomInstance.attach(document.querySelectorAll('.post-content img.previewable-image'))
        }

        if (window.mediumZoom) {
            applyMediumZoom()
            return
        }

        if (window.__mediumZoomLoading) return
        window.__mediumZoomLoading = true

        ensureScriptOnce('medium-zoom-script', 'https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js').then(function() {
            applyMediumZoom()
        }).catch(function() {
        }).finally(function() {
            window.__mediumZoomLoading = false
        })
    }

    function initHeadingAnchors() {
        var content = document.querySelector('.post-content')
        if (!content) return

        var headings = content.querySelectorAll('h2, h3, h4, h5, h6')
        if (!headings.length) return

        var usedIds = {}
        var slugify = function(text) {
            return text
                .trim()
                .toLowerCase()
                .replace(/\s+/g, '-')
                .replace(/[^\w\-]/g, '')
        }

        Array.prototype.forEach.call(headings, function(heading) {
            if (heading.querySelector('.header-anchor')) return

            var existingLink = heading.querySelector('.headerlink')
            var text = (heading.textContent || '').trim()
            if (!text) return

            var id = heading.id
            if (!id) {
                var base = slugify(text)
                if (!base) base = 'section'
                var candidate = base
                var count = 1
                while (document.getElementById(candidate) || usedIds[candidate]) {
                    count += 1
                    candidate = base + '-' + count
                }
                heading.id = candidate
                id = candidate
            }

            usedIds[id] = true

            if (existingLink) {
                var linkText = (existingLink.textContent || '').trim()
                if (!linkText || linkText === '#') {
                    existingLink.textContent = '#'
                    existingLink.classList.add('header-anchor')
                    existingLink.setAttribute('aria-label', '跳转到 ' + text)
                    existingLink.href = '#' + id
                    return
                }
            }

            var anchor = document.createElement('a')
            anchor.className = 'header-anchor'
            anchor.href = '#' + id
            anchor.setAttribute('aria-label', '跳转到 ' + text)
            anchor.textContent = '#'
            heading.insertBefore(anchor, heading.firstChild)
        })
    }

    function initPostToc() {
        if (typeof __postTocCleanup === 'function') {
            __postTocCleanup()
            __postTocCleanup = null
        }

        var toc = document.querySelector('.post-toc')
        if (!toc) return

        var listWrap = toc.querySelector('.post-toc-list-wrap')
        var indicator = toc.querySelector('.post-toc-indicator')
        var list = toc.querySelector('.post-toc-list')
        var content = document.querySelector('.post-content')
        if (!listWrap || !list || !content) return

        var headings = content.querySelectorAll('h2, h3, h4')
        if (!headings.length) {
            toc.style.display = 'none'
            return
        }

        list.innerHTML = ''

        var usedIds = {}
        var items = []

        var slugify = function(text) {
            return text
                .trim()
                .toLowerCase()
                .replace(/\s+/g, '-')
                .replace(/[^\w\-]/g, '')
        }

        Array.prototype.forEach.call(headings, function(heading) {
            var text = (heading.textContent || '').trim()
            if (!text) return

            var id = heading.id
            if (!id) {
                var base = slugify(text)
                if (!base) base = 'section'
                var candidate = base
                var count = 1
                while (document.getElementById(candidate) || usedIds[candidate]) {
                    count += 1
                    candidate = base + '-' + count
                }
                heading.id = candidate
                id = candidate
            }

            usedIds[id] = true

            var level = parseInt(heading.tagName.replace('H', ''), 10) || 2
            var li = document.createElement('li')
            li.className = 'post-toc-item level-' + level

            var link = document.createElement('a')
            link.className = 'post-toc-link'
            link.href = '#' + id
            link.textContent = text
            link.setAttribute('data-toc-target', id)

            li.appendChild(link)
            list.appendChild(li)

            items.push({
                id: id,
                li: li,
                link: link,
                heading: heading
            })
        })

        if (!items.length) {
            toc.style.display = 'none'
            return
        }

        var prefersReducedMotion = false
        if (window.matchMedia) {
            prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches
        }

        var getHeaderOffset = function() {
            var header = document.querySelector('.site-header')
            return header ? header.getBoundingClientRect().height : 0
        }

        var smoothScrollTo = function(targetY, duration) {
            var start = window.scrollY || document.documentElement.scrollTop || 0
            var distance = targetY - start
            if (Math.abs(distance) < 1) return

            var startTime = null
            var step = function(timestamp) {
                if (!startTime) startTime = timestamp
                var progress = Math.min((timestamp - startTime) / duration, 1)
                var eased = 1 - Math.pow(1 - progress, 3)
                window.scrollTo(0, Math.round(start + distance * eased))
                if (progress < 1) {
                    window.requestAnimationFrame(step)
                }
            }

            window.requestAnimationFrame(step)
        }

        var alignToHash = function() {
            if (!window.location || !window.location.hash) return

            var rawId = window.location.hash.slice(1)
            if (!rawId) return

            var id = rawId
            try {
                id = decodeURIComponent(rawId)
            } catch (err) {
            }

            var targetEl = document.getElementById(id)
            if (!targetEl) return

            var headerOffset = getHeaderOffset()
            var rect = targetEl.getBoundingClientRect()
            var target = rect.top + (window.scrollY || document.documentElement.scrollTop || 0) - headerOffset
            if (target < 0) target = 0
            window.scrollTo(0, Math.round(target))
        }

        var headingTops = []
        var refreshHeadingTops = function() {
            headingTops = []
            var scrollTop = window.scrollY || document.documentElement.scrollTop || 0
            for (var i = 0; i < items.length; i += 1) {
                var rect = items[i].heading.getBoundingClientRect()
                headingTops.push(rect.top + scrollTop)
            }
        }

        var updateIndicator = function(activeItem) {
            if (!indicator || !activeItem) return
            var offset = activeItem.li.offsetTop - list.scrollTop
            indicator.style.transform = 'translateY(' + offset + 'px)'
            indicator.style.height = Math.max(activeItem.li.offsetHeight - 4, 10) + 'px'
        }

        var ensureVisible = function(activeItem) {
            var top = activeItem.li.offsetTop
            var bottom = top + activeItem.li.offsetHeight
            if (top < list.scrollTop + 6) {
                list.scrollTop = Math.max(top - 6, 0)
                return
            }
            if (bottom > list.scrollTop + list.clientHeight - 6) {
                list.scrollTop = bottom - list.clientHeight + 6
            }
        }

        var updateActive = function() {
            if (window.__isProgrammaticScroll) return
            if (!headingTops.length) {
                refreshHeadingTops()
            }
            var scrollTop = window.scrollY || document.documentElement.scrollTop || 0
            var threshold = scrollTop + 140
            var activeIndex = 0
            for (var i = 0; i < headingTops.length; i += 1) {
                if (headingTops[i] <= threshold) {
                    activeIndex = i
                } else {
                    break
                }
            }
            var active = items[activeIndex] || items[0]

            items.forEach(function(item) {
                item.li.classList.toggle('is-active', item === active)
            })

            ensureVisible(active)
            updateIndicator(active)
        }

        refreshHeadingTops()
        var unregisterScroll = registerScrollHandler(updateActive)
        var onResize = function() {
            refreshHeadingTops()
            updateActive()
        }
        var onLoad = function() {
            refreshHeadingTops()
            updateActive()
            alignToHash()
        }
        window.addEventListener('resize', onResize)
        window.addEventListener('load', onLoad)
        window.addEventListener('hashchange', alignToHash)
        __postTocCleanup = function() {
            if (typeof unregisterScroll === 'function') {
                unregisterScroll()
            }
            window.removeEventListener('resize', onResize)
            window.removeEventListener('load', onLoad)
            window.removeEventListener('hashchange', alignToHash)
        }
        updateActive()
        window.setTimeout(alignToHash, 0)
        window.setTimeout(alignToHash, 120)

        var contentImages = content.querySelectorAll('img')
        if (contentImages && contentImages.length) {
            Array.prototype.forEach.call(contentImages, function(image) {
                if (image.complete) return
                image.addEventListener('load', function() {
                    refreshHeadingTops()
                    updateActive()
                }, { once: true })
                image.addEventListener('error', function() {
                    refreshHeadingTops()
                    updateActive()
                }, { once: true })
            })
        }

        var releaseForceCollapse = function() {
            toc.classList.remove('is-force-collapsed')
        }

        toc.addEventListener('mouseleave', releaseForceCollapse)

        items.forEach(function(item) {
            item.link.addEventListener('click', function(event) {
                if (event.defaultPrevented) return
                if (event.button !== 0) return
                if (event.metaKey || event.ctrlKey || event.shiftKey || event.altKey) return

                event.preventDefault()

                var headerOffset = getHeaderOffset()
                var rect = item.heading.getBoundingClientRect()
                var target = rect.top + (window.scrollY || document.documentElement.scrollTop || 0) - headerOffset
                if (target < 0) target = 0

                if (prefersReducedMotion) {
                    window.scrollTo(0, target)
                } else {
                    smoothScrollTo(target, 450)
                }

                var keepOpen = false
                if (toc.matches) {
                    keepOpen = toc.matches(':hover') || toc.matches(':focus-within')
                }
                if (!keepOpen) {
                    toc.classList.add('is-force-collapsed')
                } else {
                    toc.classList.remove('is-force-collapsed')
                }

                if (typeof event.detail === 'number' ? event.detail > 0 : true) {
                    if (item.link && typeof item.link.blur === 'function') {
                        item.link.blur()
                    }
                }

                if (item.id) {
                    window.history.pushState(null, '', '#' + item.id)
                }
            })
        })
    }

    function initPageFeatures() {
        updateNavActiveState()
        initGiscusLazy()
        initImagePreview()
        initPostToc()
        initHeadingAnchors()
        window.setTimeout(function() {
            warmPjaxLinkCache(8)
        }, 120)
    }

    function warmPjaxLinkCache(limit) {
        var links = document.querySelectorAll('#swup a')
        if (!links || !links.length) return
        var max = Number.isFinite(limit) ? limit : 8
        if (max <= 0) return

        var count = 0
        for (var i = 0; i < links.length; i += 1) {
            var link = links[i]
            if (!isPjaxEligibleLink(link)) continue
            prefetchPjaxUrl(link.getAttribute('href'))
            count += 1
            if (count >= max) break
        }
    }

    function initPjaxPrefetch() {
        if (__pjaxPrefetchBound) return

        document.addEventListener('pointerenter', function(event) {
            var link = event.target && event.target.closest ? event.target.closest('a') : null
            if (!isPjaxEligibleLink(link)) return
            prefetchPjaxUrl(link.getAttribute('href'))
        }, true)

        document.addEventListener('touchstart', function(event) {
            var link = event.target && event.target.closest ? event.target.closest('a') : null
            if (!isPjaxEligibleLink(link)) return
            prefetchPjaxUrl(link.getAttribute('href'))
        }, { capture: true, passive: true })

        __pjaxPrefetchBound = true
    }

    function applyPjaxDocument(nextDoc) {
        if (!nextDoc) return false
        var currentRoot = document.getElementById('swup')
        var nextRoot = nextDoc.getElementById('swup')
        if (!currentRoot || !nextRoot) return false

        if (typeof __postTocCleanup === 'function') {
            __postTocCleanup()
            __postTocCleanup = null
        }

        var currentMain = currentRoot.querySelector('main.container')
        var currentFooter = currentRoot.querySelector('footer')
        var nextMain = nextRoot.querySelector('main.container')
        var nextFooter = nextRoot.querySelector('footer')
        if (!currentMain || !currentFooter || !nextMain || !nextFooter) return false

        currentMain.innerHTML = nextMain.innerHTML
        currentFooter.innerHTML = nextFooter.innerHTML
        syncDocumentHead(nextDoc)
        return true
    }

    function navigateWithPjax(url, options) {
        options = options || {}

        var nextUrl = createPjaxUrl(url)
        if (!nextUrl) {
            window.location.href = url
            return Promise.resolve(false)
        }
        var href = nextUrl.href

        if (__pjaxAbortController && typeof __pjaxAbortController.abort === 'function') {
            __pjaxAbortController.abort()
        }
        __pjaxAbortController = typeof window.AbortController === 'function' ? new AbortController() : null
        setPjaxLoading(true)

        var requestOptions = { credentials: 'same-origin' }
        if (__pjaxAbortController) {
            requestOptions.signal = __pjaxAbortController.signal
        }

        return fetchPjaxHtml(nextUrl, requestOptions).then(function(html) {
            var nextDoc = new DOMParser().parseFromString(html, 'text/html')
            var applied = applyPjaxDocument(nextDoc)
            if (!applied) {
                throw new Error('PJAX target not found')
            }

            if (options.push !== false) {
                window.history.pushState({}, '', href)
            }
            __pjaxCurrentPath = getRouteKeyFromUrl(nextUrl)

            initPageFeatures()

            var nextHash = nextUrl.hash || ''
            if (!scrollToHash(nextHash)) {
                window.scrollTo(0, 0)
            }

            return true
        }).catch(function(error) {
            if (error && error.name === 'AbortError') {
                return false
            }
            window.location.href = href
            return false
        }).finally(function() {
            setPjaxLoading(false)
        })
    }

    function initPjaxNavigation() {
        if (__pjaxBound) return
        if (!document.getElementById('swup')) return
        if (typeof window.fetch !== 'function') return
        if (!window.history || typeof window.history.pushState !== 'function') return
        __pjaxCurrentPath = getRouteKeyFromUrl(new URL(window.location.href))
        initPjaxPrefetch()

        document.addEventListener('click', function(event) {
            var link = event.target.closest('a')
            if (!shouldHandlePjaxLink(link, event)) return

            event.preventDefault()
            var href = link.getAttribute('href')
            navigateWithPjax(href, { push: true })
        })

        window.addEventListener('popstate', function() {
            var currentRouteKey = getRouteKeyFromUrl(new URL(window.location.href))
            if (__pjaxCurrentPath && currentRouteKey === __pjaxCurrentPath) {
                if (!scrollToHash(window.location.hash || '')) {
                    window.scrollTo(0, 0)
                }
                return
            }
            navigateWithPjax(window.location.href, { push: false })
        })

        window.__navigateWithPjax = function(href, options) {
            return navigateWithPjax(href, options || { push: true })
        }

        __pjaxBound = true
    }

    document.addEventListener('DOMContentLoaded', function() {
        initBackToTop()
        initLogoScrollTop()
        initLive2D()
        initPjaxNavigation()
        initPageFeatures()
    })
